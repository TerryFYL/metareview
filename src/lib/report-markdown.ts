import type { MetaAnalysisResult, EggersTest, BeggsTest, SubgroupAnalysisResult, SensitivityResult, PICO, MetaRegressionResult, GradeAssessment, InfluenceDiagnostic, RobAssessments, RobDomain, Study, CumulativeResult } from './types';
import type { TrimAndFillResult } from './statistics/publication-bias';
import type { ReportSections } from './report-export';
import { defaultReportSections } from './report-export';
import { calculateNNT } from './statistics/nnt';
import { isLogScale } from './statistics';

interface MarkdownReportData {
  title: string;
  pico: PICO;
  result: MetaAnalysisResult;
  eggers: EggersTest | null;
  beggs?: BeggsTest | null;
  subgroupResult: SubgroupAnalysisResult | null;
  sensitivityResults: SensitivityResult[];
  trimFillResult?: TrimAndFillResult | null;
  metaRegression?: MetaRegressionResult | null;
  influenceDiagnostics?: InfluenceDiagnostic[];
  gradeAssessment?: GradeAssessment | null;
  robAssessments?: RobAssessments;
  studies?: Study[];
  cumulativeResults?: CumulativeResult[];
  sections?: ReportSections;
}

const fmt = (n: number, d = 2) => n.toFixed(d);
const fmtP = (p: number) => p < 0.001 ? '< 0.001' : p.toFixed(3);

export function generateReportMarkdown(data: MarkdownReportData): string {
  const { result, eggers, beggs, subgroupResult, sensitivityResults, trimFillResult, metaRegression, influenceDiagnostics, gradeAssessment, robAssessments, studies, cumulativeResults } = data;
  const sec = data.sections || defaultReportSections;
  const measure = result.measure;
  const log = isLogScale(measure);
  const lines: string[] = [];

  lines.push(`# ${data.title || 'Meta-Analysis Report'}`);
  lines.push(`\n*Generated by MetaReview (https://metareview.cc) — ${new Date().toISOString().split('T')[0]}*\n`);

  // PICO
  if (sec.pico && (data.pico.population || data.pico.intervention)) {
    lines.push('## PICO\n');
    lines.push(`| Component | Description |`);
    lines.push(`|-----------|-------------|`);
    if (data.pico.population) lines.push(`| **Population** | ${data.pico.population} |`);
    if (data.pico.intervention) lines.push(`| **Intervention** | ${data.pico.intervention} |`);
    if (data.pico.comparison) lines.push(`| **Comparison** | ${data.pico.comparison} |`);
    if (data.pico.outcome) lines.push(`| **Outcome** | ${data.pico.outcome} |`);
    lines.push('');
  }

  // Overall results
  if (sec.overall) {
    lines.push('## Overall Results\n');
    const r = result;
    const nullVal = log ? 1 : 0;
    lines.push(`- **Effect measure**: ${measure}`);
    lines.push(`- **Model**: ${r.model === 'fixed' ? 'Fixed-effects' : 'Random-effects (DerSimonian-Laird)'}`);
    lines.push(`- **Number of studies**: ${r.studies.length}`);
    lines.push(`- **Pooled estimate**: ${fmt(r.effect)} (95% CI: ${fmt(r.ciLower)}–${fmt(r.ciUpper)})`);
    lines.push(`- **p-value**: ${fmtP(r.pValue)}`);
    lines.push(`- **Heterogeneity**: Q = ${fmt(r.heterogeneity.Q)}, df = ${r.studies.length - 1}, p = ${fmtP(r.heterogeneity.pValue)}`);
    lines.push(`- **I²**: ${fmt(r.heterogeneity.I2, 1)}%`);
    lines.push(`- **τ²**: ${fmt(r.heterogeneity.tau2, 4)}`);
    if (r.predictionInterval) {
      lines.push(`- **Prediction interval**: ${fmt(r.predictionInterval.lower)}–${fmt(r.predictionInterval.upper)}`);
    }

    // NNT/NNH
    if (studies) {
      const nnt = calculateNNT(r, studies);
      if (nnt) {
        lines.push(`- **${nnt.isHarm ? 'NNH' : 'NNT'}**: ${fmt(nnt.nnt, 1)} (95% CI: ${nnt.nntCILower === Infinity ? '∞' : fmt(nnt.nntCILower, 1)}–${nnt.nntCIUpper === Infinity ? '∞' : fmt(nnt.nntCIUpper, 1)})`);
      }
    }

    lines.push('');

    // Interpretation
    if (sec.interpretation) {
      const direction = r.effect > nullVal ? 'higher' : 'lower';
      const sig = r.pValue < 0.05 ? 'statistically significant' : 'not statistically significant';
      lines.push(`**Interpretation**: The pooled ${measure} is ${fmt(r.effect)} (95% CI: ${fmt(r.ciLower)}–${fmt(r.ciUpper)}), which is ${sig} (p = ${fmtP(r.pValue)}). The point estimate suggests a ${direction} effect in the intervention group. Heterogeneity is ${r.heterogeneity.I2 < 25 ? 'low' : r.heterogeneity.I2 < 75 ? 'moderate' : 'high'} (I² = ${fmt(r.heterogeneity.I2, 1)}%).\n`);
    }
  }

  // Study table
  if (sec.studyTable && result.studies.length > 0) {
    lines.push('## Individual Studies\n');
    const useRandom = result.model === 'random';
    lines.push(`| Study | ${measure} | 95% CI | Weight |`);
    lines.push(`|-------|${'-'.repeat(measure.length + 2)}|--------|--------|`);
    for (const s of result.studies) {
      const w = useRandom ? s.weightRandom : s.weightFixed;
      lines.push(`| ${s.name} | ${fmt(s.yi)} | ${fmt(s.ciLower)}–${fmt(s.ciUpper)} | ${fmt(w, 1)}% |`);
    }
    lines.push('');
  }

  // Publication bias
  if ((sec.eggers && eggers) || (sec.beggs && beggs)) {
    lines.push('## Publication Bias\n');
    if (eggers) {
      lines.push(`- **Egger's test**: intercept = ${fmt(eggers.intercept, 3)}, t = ${fmt(eggers.tValue, 3)}, p = ${fmtP(eggers.pValue)}`);
      lines.push(`  - ${eggers.pValue < 0.05 ? '⚠️ Significant asymmetry detected' : 'No significant asymmetry'}`);
    }
    if (beggs) {
      lines.push(`- **Begg's test**: τ = ${fmt(beggs.tau, 3)}, p = ${fmtP(beggs.pValue)}`);
    }
    if (trimFillResult && trimFillResult.k0 > 0) {
      lines.push(`- **Trim-and-Fill**: ${trimFillResult.k0} imputed studies, adjusted estimate = ${fmt(trimFillResult.adjustedEffect)}`);
    }
    lines.push('');
  }

  // Subgroup analysis
  if (sec.subgroup && subgroupResult) {
    lines.push('## Subgroup Analysis\n');
    lines.push(`| Subgroup | k | ${measure} | 95% CI | I² |`);
    lines.push(`|----------|---|${'-'.repeat(measure.length + 2)}|--------|-----|`);
    for (const g of subgroupResult.subgroups) {
      lines.push(`| ${g.name} | ${g.result.studies.length} | ${fmt(g.result.effect)} | ${fmt(g.result.ciLower)}–${fmt(g.result.ciUpper)} | ${fmt(g.result.heterogeneity.I2, 1)}% |`);
    }
    if (subgroupResult.test.pValue != null) {
      lines.push(`\nInteraction test: Q = ${fmt(subgroupResult.test.Q)}, p = ${fmtP(subgroupResult.test.pValue)}`);
    }
    lines.push('');
  }

  // Sensitivity analysis
  if (sec.sensitivity && sensitivityResults.length > 0) {
    lines.push('## Sensitivity Analysis (Leave-One-Out)\n');
    lines.push(`| Omitted | ${measure} | 95% CI | I² |`);
    lines.push(`|---------|${'-'.repeat(measure.length + 2)}|--------|-----|`);
    for (const s of sensitivityResults) {
      lines.push(`| ${s.omittedStudy} | ${fmt(s.effect)} | ${fmt(s.ciLower)}–${fmt(s.ciUpper)} | ${fmt(s.I2, 1)}% |`);
    }
    lines.push('');
  }

  // Meta-regression
  if (sec.metaReg && metaRegression) {
    lines.push('## Meta-Regression\n');
    lines.push(`- **Covariate**: ${metaRegression.covariate}`);
    lines.push(`- **Intercept**: ${fmt(metaRegression.intercept, 4)}`);
    lines.push(`- **Coefficient**: ${fmt(metaRegression.coefficient, 4)}`);
    lines.push(`- **p-value**: ${fmtP(metaRegression.pValue)}`);
    lines.push(`- **R²**: ${fmt((metaRegression.R2 ?? 0) * 100, 1)}%`);
    lines.push('');
  }

  // Influence diagnostics
  if (sec.influence && influenceDiagnostics && influenceDiagnostics.length > 0) {
    lines.push('## Influence Diagnostics\n');
    const k = influenceDiagnostics.length;
    const threshold = 4 / k;
    const influential = influenceDiagnostics.filter(d => d.cooksDistance > threshold);
    if (influential.length > 0) {
      lines.push(`**Potentially influential studies**: ${influential.map(d => d.name).join(', ')}\n`);
    } else {
      lines.push('No individually influential studies detected.\n');
    }
  }

  // GRADE
  if (sec.grade && gradeAssessment) {
    lines.push('## GRADE Assessment\n');
    lines.push(`**Overall certainty**: ${gradeAssessment.overall.toUpperCase()}\n`);
    const GRADE_LABELS: Record<string, string> = {
      riskOfBias: 'Risk of Bias',
      inconsistency: 'Inconsistency',
      indirectness: 'Indirectness',
      imprecision: 'Imprecision',
      publicationBias: 'Publication Bias',
    };
    lines.push(`| Domain | Rating | Reason |`);
    lines.push(`|--------|--------|--------|`);
    for (const [key, factor] of Object.entries(gradeAssessment.factors)) {
      lines.push(`| ${GRADE_LABELS[key] || key} | ${factor.level} | ${factor.reasoning || '—'} |`);
    }
    lines.push('');
  }

  // RoB
  if (sec.rob && robAssessments && Object.keys(robAssessments).length > 0) {
    lines.push('## Risk of Bias\n');
    const DOMAINS: RobDomain[] = ['d1_randomization', 'd2_deviations', 'd3_missing', 'd4_measurement', 'd5_selection'];
    const DOMAIN_LABELS: Record<RobDomain, string> = {
      d1_randomization: 'Randomization', d2_deviations: 'Deviations', d3_missing: 'Missing data', d4_measurement: 'Measurement', d5_selection: 'Selection',
    };
    lines.push(`| Study | ${DOMAINS.map(d => DOMAIN_LABELS[d]).join(' | ')} | Overall |`);
    lines.push(`|-------|${DOMAINS.map(() => '---').join('|')}|---------|`);
    for (const [study, assessment] of Object.entries(robAssessments)) {
      const cells = DOMAINS.map(d => assessment.domains[d] || '—');
      lines.push(`| ${study} | ${cells.join(' | ')} | ${assessment.overall} |`);
    }
    lines.push('');
  }

  // Cumulative
  if (sec.cumulative && cumulativeResults && cumulativeResults.length > 0) {
    lines.push('## Cumulative Meta-Analysis\n');
    lines.push(`| Added Study | ${measure} | 95% CI |`);
    lines.push(`|-------------|${'-'.repeat(measure.length + 2)}|--------|`);
    for (const c of cumulativeResults) {
      lines.push(`| ${c.addedStudy} | ${fmt(c.effect)} | ${fmt(c.ciLower)}–${fmt(c.ciUpper)} |`);
    }
    lines.push('');
  }

  // Methods
  if (sec.methods) {
    lines.push('## Methods\n');
    lines.push(`This meta-analysis was conducted using MetaReview (https://metareview.cc). ${result.model === 'random' ? 'Random-effects model with DerSimonian-Laird estimator' : 'Fixed-effects model (inverse-variance method)'} was used. Effect sizes are reported as ${measure} with 95% confidence intervals. Heterogeneity was assessed using Cochran's Q test and the I² statistic.`);
    lines.push('');
  }

  lines.push('---\n');
  lines.push('*Note: Plots (forest plot, funnel plot, etc.) are available in the HTML export.*');

  return lines.join('\n');
}
